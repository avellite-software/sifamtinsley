{% comment %}
  V7 - Custom Product Page
  - Moved 'Back to Collection' button inside the info column to fix background layout.
  - Preserved all previous functionality (Tabs, Modal Form, etc.).
{% endcomment %}

{%- style -%}
  /* The main section now acts as an overflow container for the full-bleed element */
  .product-page-section {
    overflow-x: hidden;
    padding-top: 0; /* Removed extra padding */
  }

  .product-section-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1.5rem;
    position: relative;
  }

  /* --- Back Button Styles --- */
  .back-to-collection {
    display: inline-flex;
    align-items: center;
    text-decoration: none;
    color: #666;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 2rem; /* Increased spacing */
    transition: color 0.2s ease;
  }
  .back-to-collection:hover {
    color: #c1151b;
  }
  .back-to-collection svg {
    width: 1.2em;
    height: 1.2em;
    margin-right: 0.5rem;
    fill: currentColor;
  }

  /* Ensure the container clips the ribbon */
  .product-image-column {
    position: relative;
    overflow: hidden;
    border-radius: 12px; /* Optional: matches your other cards */
  }

  .status-ribbon {
    position: absolute;
    top: 25px;
    right: -55px;
    width: 200px;
    text-align: center;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 8px 0;
    transform: rotate(45deg);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    z-index: 10;
    pointer-events: none;
    line-height: 1.2;
  }

  /* ==============================================
     TOP SECTION: Image & Main Info
     ============================================== */
  .product-main-container {
    display: grid;
    grid-template-columns: 45fr 55fr;
    gap: 0;
    margin-bottom: 4rem;
  }

  .product-image-column img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .product-info-column {
    padding: 40px;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .product-info-column::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: -1;
    background-color: #f5f5f5;
    border-bottom-left-radius: 50px;
    width: 100vw;
  }

  .product-info-column__vendor {
    text-transform: uppercase;
    color: #666;
    font-size: 0.9rem;
    letter-spacing: 0.1em;
    margin-bottom: 0.5rem;
  }

  .product-info-column__title {
    font-size: 5.8rem;
    margin: 0 0 1rem;
    line-height: 1.2;
  }

  .product-info-column .product__description {
    font-size: 1.5rem;
    line-height: 1.7;
    color: #333;
    flex-grow: 1;
  }

  /* ==============================================
     SUPPORT BOX STYLES
     ============================================== */
  .support-box-wrapper {
    margin-top: auto;
    padding-top: 2rem;
  }
  .support-box {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    text-align: center;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .support-box-content {
    padding: 40px 40px 30px;
    flex-grow: 1;
  }
  .support-box-heading {
    font-size: 32px;
    font-weight: 800;
    color: #1c1c1c;
    margin: 0 0 15px;
  }
  .support-box-subheading {
    font-size: 16px;
    line-height: 1.6;
    color: #555;
    margin: 0 0 30px;
  }
  .support-box-phone {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    margin: 0;
    display: block;
  }
  .support-box-button {
    display: block;
    width: 100%;
    background-color: #c1151b;
    color: #fff;
    text-decoration: none;
    font-size: 18px;
    font-weight: 600;
    padding: 15px 20px;
    transition: background-color 0.2s;
    border-radius: 0 0 12px 12px;
    border: none;
    cursor: pointer;
  }
  .support-box-button:hover {
    background-color: #a10f16;
  }

  /* ==============================================
     BOTTOM SECTION: Tabs for Metafields
     ============================================== */
  .product-tabs-wrapper {
    padding-bottom: 3rem;
    padding-top: 7rem;
  }
  .product-tabs-container {
    background-color: #fff;
    border: 1px solid #e5e5e5;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    border-radius: 0 12px 12px 12px;
    position: relative;
  }
  .product-tabs-nav {
    display: flex;
    list-style: none;
    margin: 0;
    padding: 0;
    position: absolute;
    top: -55px;
    left: -1px;
  }
  .product-tabs-nav__item {
    background-color: #f0f0f0;
    color: #333;
    padding: 12px 25px;
    cursor: pointer;
    border: 1px solid #e5e5e5;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    margin-right: 5px;
    font-weight: 600;
    transition: background-color 0.2s ease;
  }
  .product-tabs-nav__item:hover {
    background-color: #e0e0e0;
  }
  .product-tabs-nav__item.is-active {
    background-color: #fff;
    border-bottom: 1px solid #fff;
    position: relative;
    top: 1px;
  }
  .product-tabs-content {
    padding: 60px 40px 40px;
  }
  .product-tabs-content__panel {
    display: none;
  }
  .product-tabs-content__panel.is-active {
    display: block;
  }
  .product-tabs-content__panel .rte p {
    margin: 0 0 1em;
  }
  .product-tabs-content__panel .rte ul,
  .product-tabs-content__panel .rte ol {
    margin: 1em 0;
    padding-left: 1.5em;
  }
  .product-tabs-content__panel .rte li {
    margin-bottom: 0.5em;
  }
  .product-file-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .product-file-list li {
    margin-bottom: 0.75rem;
  }
  .product-file-list a {
    text-decoration: none;
    color: #c1151b;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .product-file-list a:hover {
    text-decoration: underline;
  }

  /* ==============================================
     CONTACT MODAL STYLES
     ============================================== */
  .contact-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .contact-modal.is-open {
    display: flex;
    opacity: 1;
  }
  .contact-modal__content {
    background: #fff;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    position: relative;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    transform: translateY(20px);
    transition: transform 0.3s ease;
  }
  .contact-modal.is-open .contact-modal__content {
    transform: translateY(0);
  }
  .contact-modal__close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
  }
  .contact-modal__title {
    margin-top: 0;
    margin-bottom: 1.5rem;
    font-size: 1.8rem;
    font-weight: 700;
  }
  .contact-form__field {
    margin-bottom: 1rem;
  }
  .contact-form__label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }
  .contact-form__input,
  .contact-form__textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
  }
  .contact-form__submit {
    background-color: #c1151b;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    margin-top: 1rem;
  }
  .contact-form__submit:hover {
    background-color: #a10f16;
  }

  /* Mobile responsiveness */
  @media screen and (max-width: 768px) {
    .product-main-container {
      grid-template-columns: 1fr;
    }
    .product-info-column {
      border-radius: 0;
    }
    .product-info-column::before {
      border-bottom-left-radius: 50px;
      border-bottom-right-radius: 50px;
    }
    .product-tabs-container {
      border-radius: 50px;
    }
    .product-tabs-nav {
      position: static;
      flex-wrap: wrap;
      border-bottom: 1px solid #e5e5e5;
    }
    .product-tabs-nav__item {
      border-radius: 0;
      border: none;
      flex-grow: 1;
      text-align: center;
    }
    .product-tabs-nav__item.is-active {
      background-color: #f0f0f0;
      border-bottom: 2px solid #c1151b;
      top: 0;
    }
    .product-tabs-content {
      padding: 30px 20px;
    }
  }
{%- endstyle -%}

{%- liquid
  assign features_metafield = product.metafields.custom.features
  assign downloads_content = product.metafields.custom.downloads.value
  assign certifications_content = product.metafields.custom.certifications.value

  # Logic to find the "Back to" link
  assign back_url = routes.all_products_collection_url
  assign back_text = 'All Products'

  if collection
    assign back_url = collection.url
    assign back_text = collection.title
  elsif product.collections.first
    assign back_url = product.collections.first.url
    assign back_text = product.collections.first.title
  endif
-%}

<section class="color-{{ section.settings.color_scheme }} product-page-section">
  <div class="product-section-wrapper">
    <div class="product-main-container">
      <div class="product-image-column">
        {% comment %} --- INSERT THIS BLOCK START --- {% endcomment %}
        {%- liquid
          assign ribbon_text = ''
          assign ribbon_bg = ''
          assign ribbon_txt_color = '#ffffff'

          # 1. Check Sold Out
          if product.available == false
            assign ribbon_text = 'Sold Out'
            assign ribbon_bg = '#555555'
            # 2. Check Sale
          elsif product.compare_at_price > product.price
            assign ribbon_text = 'Sale'
            assign ribbon_bg = '#c1151b'
            # 3. Check Custom Metafield
          elsif product.metafields.custom.status_label.value != blank
            assign ribbon_text = product.metafields.custom.status_label.value
            assign ribbon_bg = product.metafields.custom.status_color.value | default: '#333333'
            assign ribbon_txt_color = product.metafields.custom.status_text_color.value | default: '#ffffff'
          endif
        -%}

        {%- if ribbon_text != blank -%}
          <div class="status-ribbon" style="background-color: {{ ribbon_bg }}; color: {{ ribbon_txt_color }};">
            {{ ribbon_text }}
          </div>
        {%- endif -%}
        {% comment %} --- INSERT THIS BLOCK END --- {% endcomment %}

        {%- if product.featured_image -%}
          <img
            src="{{ product.featured_image | image_url: width: 1024 }}"
            alt="{{ product.featured_image.alt | escape }}"
            width="{{ product.featured_image.width }}"
            height="{{ product.featured_image.height }}"
            loading="eager"
          >
        {%- else -%}
          {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
        {%- endif -%}
      </div>

      <div class="product-info-column">
        {% comment %} --- MODIFIED: Back Button Moved Here --- {% endcomment %}
        <a href="{{ back_url }}" class="back-to-collection">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
          Back to {{ back_text }}
        </a>

        <p class="product-info-column__vendor">{{ product.vendor }}</p>
        <h1 class="product-info-column__title">{{ product.title }}</h1>

        {%- if product.description != blank -%}
          <div class="product__description rte">
            {{ product.description }}
          </div>
        {%- endif -%}

        <div class="support-box-wrapper">
          <div class="support-box">
            <div class="support-box-content">
              <h2 class="support-box-heading">{{ section.settings.box_heading }}</h2>
              <p class="support-box-subheading">{{ section.settings.box_subheading }}</p>
              <span class="support-box-phone">{{ section.settings.box_phone }}</span>
            </div>

            <button type="button" class="support-box-button js-open-contact-modal">
              {{ section.settings.button_label }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="product-section-wrapper product-tabs-wrapper">
    {%- if features_metafield.value != blank or downloads_content != blank or certifications_content != blank -%}
      <div class="product-tabs-container">
        <ul class="product-tabs-nav" role="tablist">
          {%- if features_metafield.value != blank -%}
            <li class="product-tabs-nav__item" data-tab="features" role="tab">Features</li>
          {%- endif -%}
          {%- if downloads_content != blank -%}
            <li class="product-tabs-nav__item" data-tab="downloads" role="tab">Downloads</li>
          {%- endif -%}
          {%- if certifications_content != blank -%}
            <li class="product-tabs-nav__item" data-tab="certifications" role="tab">Certifications</li>
          {%- endif -%}
        </ul>
        <div class="product-tabs-content">
          {%- if features_metafield.value != blank -%}
            <div class="product-tabs-content__panel" data-content="features" role="tabpanel">
              {{ features_metafield | metafield_tag }}
            </div>
          {%- endif -%}
          {%- if downloads_content != blank -%}
            <div class="product-tabs-content__panel" data-content="downloads" role="tabpanel">
              <ul class="product-file-list">
                {%- for file in downloads_content -%}
                  <li>
                    <a href="{{ file.url }}" target="_blank">
                      {{ file.url | split: '/' | last | split: '?' | first | replace: '%20', ' ' }}
                    </a>
                  </li>
                {%- endfor -%}
              </ul>
            </div>
          {%- endif -%}
          {%- if certifications_content != blank -%}
            <div class="product-tabs-content__panel" data-content="certifications" role="tabpanel">
              <ul class="product-file-list">
                {%- for file in certifications_content -%}
                  <li>
                    <a href="{{ file.url }}" target="_blank">
                      {{ file.url | split: '/' | last | split: '?' | first | replace: '%20', ' ' }}
                    </a>
                  </li>
                {%- endfor -%}
              </ul>
            </div>
          {%- endif -%}
        </div>
      </div>
    {%- endif -%}
  </div>

  {% comment %} --- CONTACT MODAL --- {% endcomment %}
  <div id="ProductContactModal" class="contact-modal" role="dialog" aria-modal="true">
    <div class="contact-modal__content">
      <button type="button" class="contact-modal__close js-close-contact-modal" aria-label="Close">&times;</button>
      <h2 class="contact-modal__title">Email Support</h2>

      {%- form 'contact', id: 'ProductContactForm' -%}
        {%- if form.posted_successfully? -%}
          <p class="form-status form-status--success" style="color: green; margin-bottom: 1rem;">
            Thanks for contacting us. We'll get back to you as soon as possible.
          </p>
        {%- elsif form.errors -%}
          <div class="form-status form-status--error" style="color: red; margin-bottom: 1rem;">
            {{ form.errors | default_errors }}
          </div>
        {%- endif -%}

        <div class="contact-form__field">
          <label class="contact-form__label" for="ContactForm-name">Name</label>
          <input
            class="contact-form__input"
            type="text"
            id="ContactForm-name"
            name="contact[name]"
            value="{% if form.name %}{{ form.name }}{% elsif customer %}{{ customer.name }}{% endif %}"
            required
          >
        </div>
        <div class="contact-form__field">
          <label class="contact-form__label" for="ContactForm-email">Email</label>
          <input
            class="contact-form__input"
            type="email"
            id="ContactForm-email"
            name="contact[email]"
            value="{% if form.email %}{{ form.email }}{% elsif customer %}{{ customer.email }}{% endif %}"
            required
          >
        </div>
        <div class="contact-form__field">
          <label class="contact-form__label" for="ContactForm-body">Message</label>
          <textarea
            class="contact-form__textarea"
            id="ContactForm-body"
            name="contact[body]"
            rows="5"
            required>Enquiry about {{ product.title }}</textarea>
        </div>
        <button type="submit" class="contact-form__submit">Send Message</button>
      {%- endform -%}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Tab Logic
    const tabsContainer = document.querySelector('.product-tabs-container');
    if (tabsContainer) {
      const tabs = tabsContainer.querySelectorAll('.product-tabs-nav__item');
      const contentPanels = tabsContainer.querySelectorAll('.product-tabs-content__panel');

      if (tabs.length > 0) {
        const firstTab = tabs[0];
        const firstContentId = firstTab.getAttribute('data-tab');
        const firstContentPanel = tabsContainer.querySelector(`[data-content="${firstContentId}"]`);
        firstTab.classList.add('is-active');
        if (firstContentPanel) firstContentPanel.classList.add('is-active');
      }

      tabs.forEach((tab) => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          tabs.forEach((item) => item.classList.remove('is-active'));
          contentPanels.forEach((panel) => panel.classList.remove('is-active'));
          tab.classList.add('is-active');
          const activePanel = tabsContainer.querySelector(`[data-content="${tabId}"]`);
          if (activePanel) {
            activePanel.classList.add('is-active');
          }
        });
      });
    }

    // Modal Logic
    const modal = document.getElementById('ProductContactModal');
    const openBtn = document.querySelector('.js-open-contact-modal');
    const closeBtn = document.querySelector('.js-close-contact-modal');

    if (modal && openBtn && closeBtn) {
      openBtn.addEventListener('click', () => {
        modal.classList.add('is-open');
      });

      const closeModal = () => {
        modal.classList.remove('is-open');
      };

      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }
  });
</script>

{% schema %}
{
  "name": "Product information",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Support Box Content"
    },
    {
      "type": "text",
      "id": "box_heading",
      "label": "Heading",
      "default": "Sales & Support"
    },
    {
      "type": "text",
      "id": "box_subheading",
      "label": "Subheading",
      "default": "A dedicated support team to support new purchases, technical queries, troubleshooting, and delivery information."
    },
    {
      "type": "text",
      "id": "box_phone",
      "label": "Phone Number",
      "default": "Call 01376 335271"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "Email Support"
    },
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    }
  ]
}
{% endschema %}
