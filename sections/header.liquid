{% comment %}
  - V4 Changes:
  - Removed incorrect positioning from circle-dropdown-trigger.
  - Restored missing CSS for the search button.
{% endcomment %}

<div class="header-wrapper">
  {%- liquid
    assign announcement_text = section.settings.announcement_text | strip
    if announcement_text != blank
      assign bar_modifier_class = 'announcement-bar--has-content'
    else
      assign bar_modifier_class = 'announcement-bar--no-content'
    endif
  -%}

  <div class="announcement-bar {{ bar_modifier_class }}">
    <div></div>
    {%- if announcement_text != blank -%}
      {{ announcement_text }}
    {%- endif -%}
  </div>

  <header class="custom-header">
    <div class="header-shape-clipper--default"><div></div></div>

    {%- liquid
      assign link_height_in_px = 45
      assign extra_padding_in_px = 40
      assign number_of_links = section.settings.brands_menu.links.size
      assign calculated_height = number_of_links | times: link_height_in_px | plus: extra_padding_in_px
    -%}
    <div class="header-shape-clipper--animated" style="--menu-height: {{ calculated_height }}px;">
      <div></div>
    </div>

    <div class="mobile-nav-panel">
      <button type="button" class="mobile-nav-close" aria-label="Close menu">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
      <div class="mobile-nav-content"></div>
    </div>

    <div class="mobile-nav-overlay"></div>

    <div class="header-left">
      <div class="circle-dropdown-container">
        <button class="circle-dropdown-trigger" aria-label="Our Brands Menu">
          <div class="brands-icon-wrapper">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="-2 -2 28 28"
              class="brands-icon-layer-2"
            >
              <path
                fill="none"
                stroke="white"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M17 14V20M14 17H20M15.6 10H18.4C18.9601 10 19.2401 10 19.454 9.89101C19.6422 9.79513 19.7951 9.64215 19.891 9.45399C20 9.24008 20 8.96005 20 8.4V5.6C20 5.03995 20 4.75992 19.891 4.54601C19.7951 4.35785 19.6422 4.20487 19.454 4.10899C19.2401 4 18.9601 4 18.4 4H15.6C15.0399 4 14.7599 4 14.546 4.10899C14.3578 4.20487 14.2049 4.35785 14.109 4.54601C14 4.75992 14 5.03995 14 5.6V8.4C14 8.96005 14 9.24008 14.109 9.45399C14.2049 9.64215 14.3578 9.79513 14.546 9.89101C14.7599 10 15.0399 10 15.6 10ZM5.6 10H8.4C8.96005 10 9.24008 10 9.45399 9.89101C9.64215 9.79513 9.79513 9.64215 9.89101 9.45399C10 9.24008 10 8.96005 10 8.4V5.6C10 5.03995 10 4.75992 9.89101 4.54601C9.79513 4.35785 9.64215 4.20487 9.45399 4.10899C9.24008 4 8.96005 4 8.4 4H5.6C5.03995 4 4.75992 4 4.54601 4.10899C4.35785 4.20487 4.20487 4.35785 4.10899 4.54601C4 4.75992 4 5.03995 4 5.6V8.4C4 8.96005 4 9.24008 4.10899 9.45399C4.20487 9.64215 4.35785 9.79513 4.54601 9.89101C4.75992 10 5.03995 10 5.6 10ZM5.6 20H8.4C8.96005 20 9.24008 20 9.45399 19.891C9.64215 19.7951 9.79513 19.6422 9.89101 19.454C10 19.2401 10 18.9601 10 18.4V15.6C10 15.0399 10 14.7599 9.89101 14.546C9.79513 14.3578 9.64215 14.2049 9.45399 14.109C9.24008 14 8.96005 14 8.4 14H5.6C5.03995 14 4.75992 14 4.54601 14.109C4.35785 14.2049 4.20487 14.3578 4.10899 14.546C4 14.7599 4 15.0399 4 15.6V18.4C4 18.9601 4 19.2401 4.10899 19.454C4.20487 19.6422 4.35785 19.7951 4.54601 19.891C4.75992 20 5.03995 20 5.6 20Z"
              />
            </svg>
          </div>
        </button>
        <div class="circle-dropdown-content">
          {%- for link in section.settings.brands_menu.links -%}
            <a href="{{ link.url }}">{{ link.title }}</a>
          {%- endfor -%}
        </div>
      </div>
      <a href="{{ routes.root_url }}" class="logo">
        {% if settings.logo %}
          <img src="{{ settings.logo | image_url: width: 512 }}" alt="{{ shop.name }}" width="512" height="auto">
        {% else %}
          <span>{{ shop.name }}</span>
        {% endif %}
      </a>
    </div>

    <div class="header-center">
      <form action="{{ routes.search_url }}" method="get" class="search-form">
        <input id="SearchBarInput" type="search" name="q" placeholder="Search..." class="search-input">
        <button type="submit" class="search-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="search-btn-icon" style="width:20px;">
            <path d="M480 272C480 317.9 465.1 360.3 440 394.7L566.6 521.4C579.1 533.9 579.1 554.2 566.6 566.7C554.1 579.2 533.8 579.2 521.3 566.7L394.7 440C360.3 465.1 317.9 480 272 480C157.1 480 64 386.9 64 272C64 157.1 157.1 64 272 64C386.9 64 480 157.1 480 272zM272 416C351.5 416 416 351.5 416 272C416 192.5 351.5 128 272 128C192.5 128 128 192.5 128 272C128 351.5 192.5 416 272 416z"/>
          </svg>
          <span class="visually-hidden">Search</span>
        </button>
      </form>
    </div>

    <div class="header-right">
      {%- for link in section.settings.main_menu.links -%}
        <div class="dropdown">
          <a href="{{ link.url }}" class="header-btn dropdown-link">
            {{ link.title }}
            {%- if link.links != empty -%}
              <span class="dropdown-caret">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                  <path d="M7 10l5 5 5-5z"/>
                </svg>
              </span>
            {%- endif -%}
          </a>
          {%- if link.links != empty -%}
            {% render 'megamenu-content', parent_link: link, main_menu: section.settings.main_menu %}
          {%- endif -%}
        </div>
      {%- endfor -%}

      {%- if section.settings.contact_button_link != blank and section.settings.contact_button_text != blank -%}
        <a href="{{ section.settings.contact_button_link }}" class="header-btn red-btn">
          {{ section.settings.contact_button_text }}
          <svg viewBox="0 0 640 640" width="18" height="18" fill="currentColor" style="margin-left: 6px;">
            <path d="M322.5 351.7L523.4 150.9L391 520.3L322.5 351.7zM489.4 117L288.6 317.8L120 249.3L489.4 117zM70.1 280.8L275.9 364.4L359.5 570.2C364.8 583.3 377.6 591.9 391.8 591.9C406.5 591.9 419.6 582.7 424.6 568.8L602.6 72C606.1 62.2 603.6 51.4 596.3 44C589 36.6 578.1 34.2 568.3 37.7L71.4 215.7C57.5 220.7 48.3 233.8 48.3 248.5C48.3 262.7 56.9 275.5 70 280.8z"/>
          </svg>
        </a>
      {%- endif -%}
      <a href="tel:+441376335271">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 640 640"
          width="26"
          height="26"
          fill="#333"
        >
          <path d="M224.2 89C216.3 70.1 195.7 60.1 176.1 65.4L170.6 66.9C106 84.5 50.8 147.1 66.9 223.3C104 398.3 241.7 536 416.7 573.1C493 589.3 555.5 534 573.1 469.4L574.6 463.9C580 444.2 569.9 423.6 551.1 415.8L453.8 375.3C437.3 368.4 418.2 373.2 406.8 387.1L368.2 434.3C297.9 399.4 241.3 341 208.8 269.3L253 233.3C266.9 222 271.6 202.9 264.8 186.3L224.2 89z"/>
        </svg>
      </a>
      <div style="display:none">
        <!-- Hidden until future confirmation of cart usage on this site -->
        <a href="{{ routes.cart_url }}" class="header-btn cart-btn" id="cart-icon-bubble">
          {%- if cart == empty -%}
            <span class="svg-wrapper">{{ 'icon-cart-empty.svg' | inline_asset_content }}</span>
          {%- else -%}
            <span class="svg-wrapper">{{ 'icon-cart.svg' | inline_asset_content }}</span>
          {%- endif -%}
          <span class="visually-hidden">{{ 'templates.cart.cart' | t }}</span>
          {%- if cart != empty -%}
            <div class="cart-count-bubble">
              {%- if cart.item_count < 100 -%}
                <span aria-hidden="true">{{ cart.item_count }}</span>
              {%- endif -%}
              <span class="visually-hidden">{{ 'sections.header.cart_count' | t: count: cart.item_count }}</span>
            </div>
          {%- endif -%}
        </a>
      </div>
    </div>

    <button type="button" class="mobile-nav-toggle" aria-label="Open menu">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
        <path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/>
      </svg>
    </button>
  </header>
</div>

<div class="header-spacer"><div></div></div>

<style>
  :root {
    --header-height: 96px;
    --header-mobile-height: 70px;
  }
  .header-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 9999;
  }
  .header-spacer {
    /* Height is set by JS */
  }
  .announcement-bar {
    width: 100%;
    background-color: #c1151b;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  .announcement-bar--no-content {
    height: 5px;
    padding: 0;
  }
  .custom-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    height: var(--header-height);
    font-family: inherit;
    position: relative;
    z-index: 9999;
    outline: none !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* <-- ADD THIS LINE */
  }

  /* ==============================================
     Circle Menu & Shape Animation Styles
     ============================================== */
  .header-shape-clipper--default {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 250px;
    z-index: 0;
    pointer-events: none;
    overflow: hidden;
    visibility: visible;
    transition: visibility 0s linear 0.5s;
  }
  .header-shape-clipper--default::before {
    content: '';
    position: absolute;
    left: -130px;
    top: -110px;
    width: 250px;
    height: 250px;
    background: #c1151b;
    border-radius: 125px;
  }
  .header-shape-clipper--animated {
    overflow: visible;
    visibility: hidden;
    position: absolute;
    top: 0;
    left: -20px;
    height: 100%;
    width: 250px;
    z-index: 0;
    pointer-events: none;
  }
  .header-shape-clipper--animated::before {
    content: '';
    position: absolute;
    background: #c1151b;
    left: 20px;
    top: 96px;
    width: 200px;
    height: var(--menu-height, 130px);
    border-radius: 0px 0px 12px 0px;
    transform: scale(0.2);
    transform-origin: 35px -65px;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    transition-delay: 0s;
  }
  .custom-header.is-circle-menu-active .header-shape-clipper--animated {
    visibility: visible;
  }
  .custom-header.is-circle-menu-active .header-shape-clipper--animated::before {
    transform: scale(1);
    opacity: 1;
    transition-delay: 0s;
  }

  /* ==============================================
     Main Header Styles
     ============================================== */
  .header-left {
    display: flex;
    align-items: center;
    gap: 32px;
    padding-left: 145px;
    position: relative;
    z-index: 1;
  }
  .circle-dropdown-container {
    position: absolute;
    left: 0;
    top: -20px;
    z-index: 2;
    width: 110px;
    height: 95px;
  }
  .circle-dropdown-trigger {
    background: none;
    border: none;
    cursor: pointer;
    position: absolute;
    z-index: 2;
    top: 50%; /* Center vertically within its container */
    left: 50%; /* Center horizontally within its container */
    transform: translate(-50%, -50%); /* Adjust for its own size */
    width: 60px; /* Set a fixed size for the button/icon area */
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
  }
  /* New styles for the icon wrapper and layers */
  .brands-icon-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex; /* For centering SVGs */
    align-items: center;
    justify-content: center;
  }
  .brands-icon-wrapper svg {
    position: absolute;

    fill: #fff; /* White color for the icon */
    transition: transform 0.4s ease-out; /* Smooth rotation */
  }

  .brands-icon-layer-1 {
    width: 35px; /* Size of the icon */
    height: 35px;
    transform: rotate(0deg);
  }
  .brands-icon-layer-2 {
    width: 50px; /* Size of the icon */
    height: 50px;
    transform: rotate(0deg);
  }

  /* Rotation on active state */
  .custom-header.is-circle-menu-active .brands-icon-layer-1 {
    transform: rotate(-45deg); /* Layer 1 rotates counter-clockwise */
  }
  .custom-header.is-circle-menu-active .brands-icon-layer-2 {
    transform: rotate(45deg); /* Layer 2 rotates clockwise */
  }

  .custom-header.is-circle-menu-active .circle-dropdown-content {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
    transition-delay: 0.1s;
  }
  .circle-dropdown-content {
    display: flex;
    position: absolute;
    top: 96px;
    min-width: 200px;
    z-index: 10;
    flex-direction: column;
    background: transparent;
    border-radius: 12px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease, visibility 0s linear 0.5s;
  }
  .custom-header.is-circle-menu-active .circle-dropdown-content {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
    transition-delay: 0.1s;
  }
  .circle-dropdown-content a {
    padding: 21px 20px;
    text-decoration: none;
    font-size: 15px;
    transition: background 0.2s;
    line-height: 1.4;
    color: #fff;
  }
  .circle-dropdown-content a:hover {
    background: rgba(0, 0, 0, 0.1);
  }
  .logo img {
    height: 56px;
    width: auto;
    display: block;
  }
  .header-center {
    flex: 1;
    display: flex;
    justify-content: center;
    padding: 0 20px;
  }
  .search-form {
    display: flex;
    gap: 10px;
    align-items: center;
    width: 100%;
    max-width: 600px;
  }
  .search-input {
    flex: 1;
    padding: 12px 20px;
    background: #f3f3f3;
    border: none;
    border-radius: 4px 0 0 4px;
    font-size: 16px;
    color: #333;
    outline: none;
  }
  /* RESTORED: Search button styles */
  .search-btn {
    background: white;
    border: none;
    border-radius: 0 4px 4px 0;
    font-size: 16px;
    color: #c1151b;
    font-weight: 600;
    padding: 12px 24px;
    cursor: pointer;
    margin-left: -4px;
    transition: background 0.2s, color 0.2s;
  }
  .search-btn:hover {
    background: #eaeaea;
    color: #a10f16;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
    padding-right: 20px;
  }
  .dropdown {
    position: relative;
  }
  .header-btn {
    position: relative;
    padding: 10px 22px;
    border-radius: 4px;
    background: none;
    color: black;
    font-weight: 900;
    text-decoration: none;
    font-size: 16px;
    transition: background 0.2s, color 0.2s;
    cursor: pointer;
    display: flex;
    align-items: center;
    white-space: nowrap;
  }
  .header-btn:hover,
  .header-btn:focus,
  .dropdown.is-open > .header-btn {
    background: #c1151b;
    color: #fff;
  }
  .red-btn {
    background: #c1151b;
    color: #fff;
    border: 1px solid #c1151b;
  }
  .dropdown-link {
    font-weight: 900;
  }
  .dropdown-caret {
    margin-left: 6px;
    display: flex;
    align-items: center;
    transition: transform 0.2s ease;
  }
  .dropdown.is-open .dropdown-caret {
    transform: rotate(180deg);
  }
  .dropdown-content {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: #fff;
    border: 1px solid #eee;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    min-width: 250px;
    z-index: 10;
    flex-direction: column;
    padding: 5px 0;
    border-radius: 0 0 4px 4px;
  }
  .dropdown.is-open .dropdown-content {
    display: flex;
  }
  .dropdown-content a {
    padding: 10px 16px;
    text-decoration: none;
    color: #333;
    font-size: 15px;
    transition: background 0.2s;
  }
  .dropdown-content a:hover {
    background: #f5f5f5;
  }
  .cart-btn {
    color: #c1151b;
  }
  .cart-btn:hover {
    background: #c1151b;
    color: #fff;
  }
  .mobile-nav-toggle,
  .mobile-nav-panel,
  .mobile-nav-overlay {
    display: none;
  }
  body.mobile-menu-open .mobile-nav-panel {
    right: 0;
  }
  body.mobile-menu-open .mobile-nav-overlay {
    display: block;
  }

  /* ==============================================
     RESPONSIVE STYLES
     ============================================== */
  @media screen and (max-width: 1400px) {
    .header-center {
      display: none;
    }

    .circle-dropdown-container,
    .header-shape-clipper--default,
    .header-shape-clipper--animated {
      display: none;
    }

    .header-left {
      padding-left: 20px;
    }
  }
  @media screen and (max-width: 1000px) {
    .custom-header {
      height: var(--header-mobile-height);
    }
    .custom-header,
    .header-left {
      padding-left: 20px;
    }
    .header-shape-clipper--default,
    .header-shape-clipper--animated,
    .circle-dropdown-container,
    .header-right {
      display: none;
    }
    .mobile-nav-toggle {
      display: block;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
    }
    .mobile-nav-panel {
      display: block;
      position: fixed;
      top: 0;
      right: -100%;
      width: 300px;
      height: 100%;
      background: #fff;
      z-index: 102;
      transition: right 0.3s ease-in-out;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }
    .mobile-nav-close {
      display: block;
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      cursor: pointer;
    }
    .mobile-nav-content {
      margin-top: 50px;
    }
    .mobile-nav-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 101;
    }
    .mobile-nav-content .header-center {
      display: block;
      padding: 0 20px 20px;
      border-bottom: 1px solid #eee;
    }
    .mobile-nav-content .header-right {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 0;
      padding: 0;
    }
    .mobile-nav-content .dropdown {
      border-bottom: 1px solid #eee;
    }
    .mobile-nav-content .header-btn {
      justify-content: space-between;
      width: 100%;
      padding: 15px 20px;
      border-radius: 0;
    }
    .mobile-nav-content .dropdown.is-open > .dropdown-content {
      display: flex;
    }
    .search-btn-icon {
      width: 1em; /* Makes icon scale with button's font-size */
      height: 1em;
      fill: currentColor; /* Makes icon inherit the button's color (black) */
      display: block;
    }
  }
</style>

{% schema %}
{
  "name": "Custom Header",
  "settings": [
    { "type": "image_picker", "id": "logo", "label": "Logo" },
    {
      "type": "link_list",
      "id": "brands_menu",
      "label": "Brands Menu",
      "info": "Select the menu for the 'Our Brands' dropdown."
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Main Menu",
      "info": "Select the main navigation menu for the header."
    },
    { "type": "text", "id": "contact_button_text", "label": "Contact Button Text", "default": "Contact Us" },
    { "type": "url", "id": "contact_button_link", "label": "Contact Button Link" },
    { "type": "header", "content": "Announcement Bar" },
    { "type": "text", "id": "announcement_text", "label": "Text", "default": "Announce something here" }
  ]
}
{% endschema %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const headerWrapper = document.querySelector('.header-wrapper');
    const headerSpacer = document.querySelector('.header-spacer');
    if (headerWrapper && headerSpacer) {
      const setSpacerHeight = () => {
        const headerHeight = headerWrapper.offsetHeight;
        headerSpacer.style.height = `${headerHeight}px`;

        // NEW LINE: This tells the CSS where to position the megamenu
        document.documentElement.style.setProperty('--header-total-height', `${headerHeight}px`);
      };
      setSpacerHeight();
      window.addEventListener('resize', setSpacerHeight);
    }

    const header = document.querySelector('.custom-header');
    if (!header) return;

    // Circle dropdown logic
    const circleDropdownContainer = header.querySelector('.circle-dropdown-container');
    if (circleDropdownContainer) {
      const circleTrigger = circleDropdownContainer.querySelector('.circle-dropdown-trigger');
      circleTrigger.addEventListener('click', (event) => {
        event.stopPropagation();
        document.querySelector('.header-right .dropdown.is-open')?.classList.remove('is-open');
        header.classList.toggle('is-circle-menu-active');
      });
    }

    // Mobile navigation logic
    const mobileNavToggle = header.querySelector('.mobile-nav-toggle');
    const mobileNavClose = header.querySelector('.mobile-nav-close');
    const mobileNavOverlay = document.querySelector('.mobile-nav-overlay');
    const mobileNavPanel = document.querySelector('.mobile-nav-panel');
    const mobileNavContent = header.querySelector('.mobile-nav-content');
    const centerEl = header.querySelector('.header-center');
    const rightEl = header.querySelector('.header-right');
    const BREAKPOINT = 1000;

    const toggleMenu = (isOpen) => {
      document.body.classList.toggle('mobile-menu-open', isOpen);
    };

    const manageNavElements = () => {
      const isMobile = window.innerWidth <= BREAKPOINT;
      if (isMobile) {
        if (centerEl && header.contains(centerEl)) mobileNavContent.prepend(centerEl);
        if (rightEl && header.contains(rightEl)) mobileNavContent.appendChild(rightEl);
      } else {
        if (centerEl && mobileNavContent.contains(centerEl)) header.insertBefore(centerEl, mobileNavToggle);
        if (rightEl && mobileNavContent.contains(rightEl)) header.insertBefore(rightEl, mobileNavToggle);
        toggleMenu(false);
      }
    };

    mobileNavToggle.addEventListener('click', () => toggleMenu(true));
    mobileNavClose.addEventListener('click', () => toggleMenu(false));
    mobileNavOverlay.addEventListener('click', () => toggleMenu(false));

    const navContentContainer = mobileNavPanel.querySelector('.mobile-nav-content');

    // --- NEW: Mobile dropdown click logic ---
    navContentContainer.addEventListener('click', (e) => {
      const dropdownLink = e.target.closest('.dropdown-link');
      if (!dropdownLink) return;

      const parentDropdown = dropdownLink.closest('.dropdown');

      // Find the mobile layout which is a CHILD of the .dropdown
      const mobileSubmenu = parentDropdown.querySelector('.megamenu__mobile-layout');

      // Find the desktop megamenu which is also a CHILD of the .dropdown
      const desktopMegamenu = parentDropdown.querySelector('.megamenu-wrapper');

      // If neither a mobile nor desktop submenu exists for this link, let it navigate
      if (!mobileSubmenu && !desktopMegamenu) {
        toggleMenu(false); // Close the mobile menu
        return; // Allow the link to work
      }

      // Prevent default navigation for any link that *has* an associated submenu
      e.preventDefault();

      // If the parent dropdown is already open, clicking again should navigate
      // This applies to the original dropdownLink's href, not the submenu's
      if (parentDropdown.classList.contains('is-open')) {
        window.location.href = dropdownLink.href;
        return;
      }

      // Close any other open dropdowns and their corresponding submenus
      const openDropdowns = navContentContainer.querySelectorAll('.dropdown.is-open');
      openDropdowns.forEach((item) => {
        if (item !== parentDropdown) {
          item.classList.remove('is-open');
          // Hide its corresponding mobile layout child
          const otherMobileSubmenu = item.querySelector('.megamenu__mobile-layout');
          if (otherMobileSubmenu) {
            otherMobileSubmenu.classList.remove('is-open');
          }
        }
      });

      // Open the clicked parent dropdown
      parentDropdown.classList.toggle('is-open');

      // And toggle the .is-open class on its mobile submenu child
      if (mobileSubmenu) {
        mobileSubmenu.classList.toggle('is-open');
      }
      // Note: The desktop megamenu (.megamenu-wrapper) is typically shown/hidden by CSS based on .dropdown.is-open,
      // so we don't need explicit JS to toggle its class unless its display logic is separate.
    });

    // Desktop touch/click support for main navigation
    const desktopNav = document.querySelector('.header-right');
    desktopNav.addEventListener('click', (e) => {
      const isMobile = window.innerWidth <= BREAKPOINT;
      if (isMobile) return;

      const dropdownLink = e.target.closest('.dropdown-link');
      if (!dropdownLink) return;

      const parentDropdown = dropdownLink.closest('.dropdown');
      const submenu = parentDropdown.querySelector('.megamenu-wrapper');

      if (!submenu) return;

      if (parentDropdown.classList.contains('is-open')) return;

      e.preventDefault();

      document.querySelectorAll('.header-right .dropdown.is-open').forEach((openDropdown) => {
        openDropdown.classList.remove('is-open');
      });

      parentDropdown.classList.add('is-open');
    });

    // Close all dropdowns if clicking outside
    document.addEventListener('click', (e) => {
      const activeDesktopDropdown = document.querySelector('.header-right .dropdown.is-open');
      if (activeDesktopDropdown && !activeDesktopDropdown.contains(e.target)) {
        activeDesktopDropdown.classList.remove('is-open');
      }

      const activeCircleDropdown = document.querySelector('.custom-header.is-circle-menu-active');
      if (activeCircleDropdown && !activeCircleDropdown.contains(e.target)) {
        activeCircleDropdown.classList.remove('is-circle-menu-active');
      }
    });

    manageNavElements();
    window.addEventListener('resize', manageNavElements);
  });
</script>
