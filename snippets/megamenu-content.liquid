{% comment %}
  This snippet renders the full-width megamenu dropdown.
  - V6 Changes:
    - Removed large liquid block.
    - Moved conditional logic (collection vs. page) inside the HTML loop.
{% endcomment %}

{% comment %} --- 2. MOBILE-ONLY LAYOUT --- {% endcomment %}
<div class="megamenu__mobile-layout">
  <ul class="megamenu-m__list">
    {%- for child_link in parent_link.links -%}
      <li class="megamenu-m__item">
        <a href="{{ child_link.url }}" class="megamenu-m__link megamenu-m__link--l2">{{ child_link.title }}</a>
        {%- if child_link.links != empty -%}
          <ul class="megamenu-m__list megamenu-m__list--l3">
            {%- for grandchild_link in child_link.links -%}
              <li class="megamenu-m__item">
                <a href="{{ grandchild_link.url }}" class="megamenu-m__link megamenu-m__link--l3">
                  {{- grandchild_link.title -}}
                </a>
              </li>
            {%- endfor -%}
          </ul>
        {%- endif -%}
      </li>
    {%- endfor -%}
  </ul>
</div>

<div class="megamenu-wrapper">
  <div class="megamenu__backgrounds">
    <div class="megamenu__nav-bg"><div></div></div>
    <div class="megamenu__content-bg"><div></div></div>
  </div>

  <div class="megamenu__layout-container page-width">
    <div class="megamenu__nav">
      <a href="{{ parent_link.url }}" class="megamenu__nav-link is-active">
        {{ parent_link.title }}
      </a>
    </div>

    {% comment %} --- RIGHT 3/4 COLUMN (Content Grid) --- {% endcomment %}
    <div class="megamenu__content-grid">
      {%- for child_link in parent_link.links -%}
        {%- liquid
          assign is_link_box = false
          if child_link.url != blank and child_link.links == empty
            assign is_link_box = true
          endif

          assign tag = 'div'
          if is_link_box
            assign tag = 'a'
          endif
        -%}

        {% comment %}
          ============================================================
          START: Conditional Rendering Logic
          ============================================================
        {% endcomment %}

        {%- if child_link.type == 'collection_link' -%}
          {% comment %}
            --- 1. COLLECTION LAYOUT (Horizontal) ---
            The link points to a Collection.
          {% endcomment %}

          {%- assign collection_object = child_link.object -%}
          {%- assign collection_image = collection_object.image
            | default: collection_object.products.first.featured_image
          -%}

          <{{ tag }}
            {% if is_link_box %}
              href="{{ child_link.url }}"
            {% endif %}
            class="megamenu__column-box megamenu__column-box--product"
          >
            <h3 class="megamenu__title">{{ child_link.title }}</h3>

            {%- if collection_image != blank -%}
              <img
                src="{{ collection_image | image_url: width: 100 }}"
                alt="{{ child_link.title | escape }}"
                class="megamenu__product-image"
                loading="lazy"
                width="50"
                height="50"
              >
            {%- endif -%}

            {%- unless is_link_box -%}
              {%- if child_link.links != empty -%}
                <ul class="megamenu__list">
                  {%- for grandchild_link in child_link.links -%}
                    <li>
                      <a href="{{ grandchild_link.url }}">{{ grandchild_link.title }}</a>
                    </li>
                  {%- endfor -%}
                </ul>
              {%- endif -%}
            {%- endunless -%}
          </{{ tag }}>

        {%- else -%}
          {% comment %}
            --- 2. PAGE LAYOUT (Vertical) ---
            This is the default for Pages, Blogs, or any other link type.
          {% endcomment %}

          {%- liquid
            assign page_image = ''
            if child_link.type == 'page_link' and child_link.object != blank
              assign page_image = child_link.object.metafields.custom.page_image.value
            endif
          -%}

          <{{ tag }}
            {% if is_link_box %}
              href="{{ child_link.url }}"
            {% endif %}
            class="megamenu__column-box megamenu__column-box--page"
          >
            <div class="megamenu__page-image-wrapper">
              {%- if page_image != blank -%}
                {{ page_image | image_url: width: 400 | image_tag: loading: 'lazy', class: 'megamenu__page-image' }}
              {%- else -%}
                <img
                  src="https://cdn.shopify.com/s/files/1/0949/2745/4595/files/sifam_tinsley_instrumentation_limited_logo.jpg?v=1759850304"
                  alt="{{ child_link.title | escape }}"
                  class="megamenu__page-image"
                  loading="lazy"
                  width="200"
                  height="200"
                >
              {%- endif -%}
            </div>

            <h3 class="megamenu__title">{{ child_link.title }}</h3>

            {%- unless is_link_box -%}
              {%- if child_link.links != empty -%}
                <ul class="megamenu__list">
                  {%- for grandchild_link in child_link.links -%}
                    <li>
                      <a href="{{ grandchild_link.url }}">{{ grandchild_link.title }}</a>
                    </li>
                  {%- endfor -%}
                </ul>
              {%- endif -%}
            {%- endunless -%}
          </{{ tag }}>
        {%- endif -%}
        {% comment %}
          ============================================================
          END: Conditional Rendering Logic
          ============================================================
        {% endcomment %}
      {%- endfor -%}
    </div>
  </div>
</div>

<style>
  .megamenu-wrapper {
    display: block; /* Always display block so we can animate height */
    position: fixed;
    left: 0;
    right: 0;
    top: var(--header-total-height, 96px);
    border-top: 1px solid #eee;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    z-index: 5;

    /* Animation Props */
    max-height: 0; /* Start closed */
    overflow: hidden; /* Hide content when closed */
    opacity: 0;
    visibility: hidden;
    transition: max-height 0.4s ease-in-out, opacity 0.3s ease, visibility 0s linear 0.4s;
  }

  .dropdown.is-open .megamenu-wrapper {
    max-height: 600px; /* Animate to open height (adjust if your menu is taller) */
    opacity: 1;
    visibility: visible;
    transition: max-height 0.4s ease-in-out, opacity 0.3s ease, visibility 0s linear 0s;
  }

  .megamenu__backgrounds {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: grid;
    grid-template-columns: calc(max(0px, (100vw - 1200px) / 2) + 300px) 1fr;
    z-index: 0;
  }

  @supports not (grid-template-columns: calc((100vw - 1200px) / 2 + 300px) 1fr) {
    .megamenu__backgrounds {
      grid-template-columns: 25% 75%;
    }
  }

  .megamenu__nav-bg {
    background-color: #f3f3f3;
    border-right: 1px solid #eee;
  }
  .megamenu__content-bg {
    background: #fff;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .megamenu__layout-container {
    display: grid;
    grid-template-columns: 1fr 3fr; /* 25% / 75% split */
    min-height: 400px;
    max-width: 1200px;
    margin: 0 auto;
    position: relative; /* Sits on top of the background */
    z-index: 1;
  }

  /* --- Left Column (Nav) --- */
  .megamenu__nav {
    padding: 2.5rem 0;
  }

  .megamenu__nav-link {
    display: block;
    font-size: 1.4rem;
    font-weight: 600;
    color: #333;
    text-decoration: none;
    padding: 0.75rem 2rem 0.75rem 1.5rem;
    transition: background-color 0.2s ease, color 0.2s ease;
    position: relative;
  }

  .megamenu__nav-link:hover {
    background-color: #eee;
  }

  .megamenu__nav-link.is-active {
    background-color: #e1e1e1;
    color: #000000;
    font-weight: 700;
    box-shadow: -100vw 0 0 #525252ff;
  }

  /* --- Right Column (Content) --- */
  .megamenu__content-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-content: flex-start;
    padding: 2.5rem;
  }

  .megamenu__column-box {
    flex: 1 1 250px; /* Grow/shrink from 250px base */
    max-width: 265px; /* Prevent over-stretching */
    min-width: 200px;
    padding: 1.5rem;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: block;
    text-decoration: none;
  }

  .megamenu__column-box:hover {
    transform: scale(1.03);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  }

  .megamenu__column-box:hover .megamenu__title {
    color: #c1151b;
  }

  .megamenu__title {
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #1c1c1c;
    transition: color 0.2s ease;
  }

  .megamenu__title--link {
    text-decoration: none;
  }

  .megamenu__column-box:hover .megamenu__title--link {
    color: #c1151b;
  }

  .megamenu__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .megamenu__list a {
    text-decoration: none;
    color: #333;
    font-size: 0.95rem;
    transition: color 0.2s ease;
  }
  .megamenu__list a:hover {
    color: #c1151b;
  }
  /* --- Special Case: Page Box (Image Top) --- */
  .megamenu__column-box--page {
    display: flex;
    flex-direction: column;
    padding: 1rem; /* Adjust padding to make room for image */
  }
  .megamenu__page-image-wrapper {
    width: 100%;
    height: 200px;
    margin-bottom: 1rem;
    border-radius: 6px;
    overflow: hidden;
    background-color: #f9f9f9;
  }
  .megamenu__page-image {
    width: 100%;
    height: 100%;
    object-fit: scale-down;
  }
  .megamenu__column-box--page .megamenu__title {
    margin: 0; /* Remove bottom margin since lists are hidden */
  }

  /* --- Special Case: Product Box (Image Right) --- */
  .megamenu__column-box--product {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }
  .megamenu__product-image {
    width: 50px;
    height: 50px;
    object-fit: contain;
    flex-shrink: 0;
    border-radius: 4px;
  }
  .megamenu__column-box--product .megamenu__title {
    margin: 0; /* Remove bottom margin since lists are hidden */
    text-align: left;
    flex-grow: 1;
  }

  /* --- Ensure hover works on new layouts --- */
  .megamenu__column-box--product:hover .megamenu__title,
  .megamenu__column-box--page:hover .megamenu__title {
    color: #c1151b;
  }

  /* --- Hide Megamenu on Mobile --- */

  .megamenu__mobile-layout {
    display: none; /* Hidden by default */
    padding: 1.5rem;
    background: #fff;
  }
  .megamenu__mobile-layout.is-open {
    display: block;
  }
  .megamenu-m__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .megamenu-m__list--l3 {
    padding-left: 1rem;
    border-left: 2px solid #f3f3f3;
    margin-top: 0.75rem;
  }
  .megamenu-m__item {
    margin-bottom: 0.75rem;
  }
  .megamenu-m__link {
    text-decoration: none;
    color: #333;
    font-size: 14px;
    transition: color 0.2s ease;
  }
  .megamenu-m__link--l2 {
    font-weight: 700;
  }
  .megamenu-m__link--l3 {
    font-size: 0.95rem;
  }
  .megamenu-m__link:hover {
    color: #c1151b;
  }

  @media screen and (max-width: 1200px) {
    .megamenu__nav-bg {
      background-color: #fff;
      border: none;
    }
    .megamenu__content-bg {
      box-shadow: none;
    }
  }
  @media screen and (max-width: 1000px) {
    .megamenu-wrapper {
      display: none !important;
    }
  }
</style>
